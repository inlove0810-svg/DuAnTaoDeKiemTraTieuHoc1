<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Tạo Đề Kiểm Tra Các Môn Tiểu Học</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Thêm font Inter cho đẹp mắt */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Tùy chỉnh thanh cuộn cho khu vực output */
        #testOutput::-webkit-scrollbar {
            width: 8px;
        }
        #testOutput::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #testOutput::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 10px;
        }
        #testOutput::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* gray-400 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-3xl p-8 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">
            Trình Tạo Đề Kiểm Tra Tiểu Học
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Chọn các tùy chọn bên dưới để AI tạo tự động một đề kiểm tra.
        </p>

        <!-- Form nhập liệu -->
        <form id="testForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Môn học -->
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">Môn học</label>
                    <select id="subject" name="subject" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="Toán">Toán</option>
                        <option value="Tiếng Việt">Tiếng Việt</option>
                        <option value="Khoa học">Khoa học</option>
                        <option value="Lịch sử và Địa lý">Lịch sử và Địa lý</option>
                        <option value="Tin học">Tin học</option>
                        <option value="Tiếng Anh">Tiếng Anh</option>
                        <option value="Công nghệ">Công nghệ</option>
                    </select>
                </div>

                <!-- Lớp -->
                <div>
                    <label for="grade" class="block text-sm font-medium text-gray-700 mb-2">Lớp</label>
                    <select id="grade" name="grade" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="1">Lớp 1</option>
                        <option value="2">Lớp 2</option>
                        <option value="3">Lớp 3</option>
                        <option value="4">Lớp 4</option>
                        <option value="5">Lớp 5</option>
                    </select>
                </div>
            </div>

            <!-- Chủ đề / Bài học -->
            <div>
                <label for="topic" class="block text-sm font-medium text-gray-700 mb-2">Chủ đề / Bài học</label>
                <input type="text" id="topic" name="topic" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ví dụ: 'Phép cộng trong phạm vi 10' hoặc 'Bài: Cây xanh quanh em'">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Số lượng câu hỏi -->
                <div>
                    <label for="numQuestions" class="block text-sm font-medium text-gray-700 mb-2">Số lượng câu hỏi</label>
                    <input type="number" id="numQuestions" name="numQuestions" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="5" min="1" max="20">
                </div>

                <!-- Loại câu hỏi -->
                <div>
                    <label for="questionType" class="block text-sm font-medium text-gray-700 mb-2">Loại câu hỏi</S>
                    <select id="questionType" name="questionType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="Trắc nghiệm (4 lựa chọn A, B, C, D)">Trắc nghiệm</option>
                        <option value="Tự luận (trả lời ngắn)">Tự luận</option>
                        <option value="Hỗn hợp (cả trắc nghiệm và tự luận)">Hỗn hợp</option>
                    </select>
                </div>
            </div>

            <!-- Nút Tạo Đề -->
            <button type="submit" id="generateBtn" class="w-full bg-blue-600 text-white p-4 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Tạo Đề
            </button>
        </form>

        <!-- Vòng xoay loading -->
        <div id="loader" class="hidden mx-auto my-8 w-16 h-16 border-t-4 border-blue-500 border-solid rounded-full animate-spin"></div>

        <!-- Thông báo lỗi -->
        <div id="error" class="text-red-600 text-center font-medium mt-4"></div>

        <!-- Khu vực hiển thị kết quả -->
        <div id="outputContainer" class="mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Đề Kiểm Tra Đã Tạo:</h2>
            <div id="testOutput" class="p-6 bg-gray-50 border border-gray-200 rounded-lg whitespace-pre-wrap font-mono text-sm max-h-96 overflow-y-auto">
                <!-- Nội dung đề kiểm tra sẽ xuất hiện ở đây -->
            </div>
            <button id="copyBtn" class="mt-6 w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition-colors duration-300">
                Sao chép nội dung
            </button>
        </div>
    </div>

    <script type="module">
        // --- Cấu hình API ---
        const API_KEY = ""; // Để trống, Canvas sẽ tự động cung cấp
        const API_URL = '/api/generate';
        const MAX_RETRIES = 5;
        const BASE_DELAY_MS = 1000;

        // --- Lấy các phần tử DOM ---
        const form = document.getElementById('testForm');
        const generateBtn = document.getElementById('generateBtn');
        const loader = document.getElementById('loader');
        const errorDiv = document.getElementById('error');
        const outputContainer = document.getElementById('outputContainer');
        const testOutput = document.getElementById('testOutput');
        const copyBtn = document.getElementById('copyBtn');

        // --- Xử lý sự kiện Submit Form ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Lấy dữ liệu từ form
            const subject = document.getElementById('subject').value;
            const grade = document.getElementById('grade').value;
            const topic = document.getElementById('topic').value;
            const numQuestions = document.getElementById('numQuestions').value;
            const questionType = document.getElementById('questionType').value;

            // Kiểm tra validation đơn giản
            if (!topic) {
                showError('Vui lòng nhập chủ đề hoặc bài học.');
                return;
            }

            // Cập nhật UI: Bắt đầu loading
            setLoading(true);

            // --- Xây dựng Prompt cho Gemini ---
            const systemPrompt = `Bạn là một trợ lý chuyên nghiệp, chuyên tạo ra các đề kiểm tra chất lượng cao cho giáo viên tiểu học tại Việt Nam. 
Đề bài phải thể hiện rõ 4 mức theo Thông tư 27 của Bộ Giáo dục và đào tạo Việt Nam, ngôn ngữ phù hợp với lứa tuổi học sinh, và bám sát chủ đề được cung cấp.
Định dạng đầu ra phải là văn bản thuần túy (plain text), sạch sẽ, dễ dàng sao chép và dán vào Microsoft Word.
Luôn bao gồm một tiêu đề chung cho bài kiểm tra (ví dụ: 'BÀI KIỂM TRA 15 PHÚT', 'ĐỀ KIỂM TRA CUỐI KỲ I').
KHÔNG cung cấp đáp án đúng hoặc lời giải. Chỉ tạo đề bài.
Khi tạo câu trắc nghiệm, luôn trình bày 3 đáp án A, B, C đối với khối 1, 2, 3 và 4 đáp án A, B, C, D rõ ràng.`;

            const userQuery = `Hãy tạo một đề kiểm tra cho:
- Môn học: ${subject}
- Lớp: ${grade}
- Chủ đề/Bài học: ${topic}
- Số lượng câu hỏi: ${numQuestions}
- Loại câu hỏi: ${questionType}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                }
            };

            // --- Gọi API với cơ chế thử lại ---
            try {
                const result = await callGeminiAPI(payload);
                
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    showResult(text);
                } else {
                    console.error('Phản hồi API không hợp lệ:', result);
                    showError('Không nhận được nội dung. Vui lòng thử lại.');
                }

            } catch (err) {
                console.error('Lỗi khi gọi API:', err);
                showError('Đã có lỗi xảy ra trong quá trình tạo đề. Vui lòng thử lại.');
            } finally {
                // Cập nhật UI: Dừng loading
                setLoading(false);
            }
        });

        // --- Hàm gọi API với Exponential Backoff ---
        async function callGeminiAPI(payload) {
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);
                    }

                    return await response.json();

                } catch (error) {
                    console.warn(`Thử lại lần ${i + 1}/${MAX_RETRIES} thất bại:`, error.message);
                    if (i === MAX_RETRIES - 1) throw error; // Ném lỗi ở lần thử cuối cùng
                    const delay = BASE_DELAY_MS * Math.pow(2, i) + (Math.random() * 1000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- Xử lý sự kiện Nút Sao chép ---
        copyBtn.addEventListener('click', () => {
            // Sử dụng document.execCommand để tương thích tốt hơn trong iframe
            const textToCopy = testOutput.textContent;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                // Phản hồi cho người dùng
                copyBtn.textContent = 'Đã sao chép!';
                copyBtn.classList.replace('bg-green-600', 'bg-yellow-500');
                setTimeout(() => {
                    copyBtn.textContent = 'Sao chép nội dung';
                    copyBtn.classList.replace('bg-yellow-500', 'bg-green-600');
                }, 2000);
            } catch (err) {
                console.error('Không thể sao chép:', err);
                showError('Không thể tự động sao chép. Vui lòng sao chép thủ công.');
            }
            
            document.body.removeChild(tempTextArea);
        });

        // --- Các hàm tiện ích cho UI ---

        function setLoading(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Đang tạo đề...';
                loader.classList.remove('hidden');
                errorDiv.textContent = '';
                outputContainer.classList.add('hidden');
            } else {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Tạo Đề';
                loader.classList.add('hidden');
            }
        }

        function showError(message) {
            errorDiv.textContent = message;
        }

        function showResult(text) {
            testOutput.textContent = text;
            outputContainer.classList.remove('hidden');
        }

    </script>
</body>
</html>
